"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value" in descriptor){descriptor.writable=true}Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps){defineProperties(Constructor.prototype,protoProps)}if(staticProps){defineProperties(Constructor,staticProps)}return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var CHANGECOLOR=true;var DIRECTIONS=[37,38,39,40];var SNAKECOLOR=["rgb(0, 0, 0)","rgb(152, 0, 0)","rgb(204, 65, 37)","rgb(91, 15, 0)","rgb(127, 96, 0)","rgb(12, 52, 61)","rgb(32, 18, 77)","rgb(76, 17, 48)","rgb(6, 2, 48)","rgb(9,32,3)","rgb(18,3,32)","rgb(3,10,32)","rgb(29,32,3)","rgb(32,9,3)","rgb(160,10,10)","rgb(160,10,64)","rgb(160,10,142)"];var $head=document.querySelector("head");if(CHANGECOLOR){var $style_s=document.createElement("style");$style_s.setAttribute("id","snake-color");var style_s="";var i=0;while(i<10000){style_s+=".n-"+i+"{background-color:"+SNAKECOLOR[Math.floor(Math.random()*SNAKECOLOR.length)]+"}";i++}$style_s.innerHTML=style_s;$head.appendChild($style_s)}var LinkItem=function LinkItem(value){_classCallCheck(this,LinkItem);this.value=value;this.next=null};var LinkedList=function(){function LinkedList(){var _this=this;var list=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];_classCallCheck(this,LinkedList);this.head=null;this.length=0;list.forEach(function(item){_this.addLast(item)})}_createClass(LinkedList,[{key:"addLast",value:function addLast(node){return this._insert(this.length,node)}},{key:"addFirst",value:function addFirst(node){return this._insert(0,node)}},{key:"removeLast",value:function removeLast(){return this._removeAt(this.length-1)}},{key:"removeFirst",value:function removeFirst(){return this._removeAt(0)}},{key:"_removeAt",value:function _removeAt(position){var node=this._get(position);return this._remove(node)}},{key:"_insert",value:function _insert(position,node){var linkItem=new LinkItem(node);if(position>=0&&position<=this.length){if(position===0){linkItem.next=this.head;this.head=linkItem}else{var current=this.head;var prev=void 0;var index=0;while(index<position){prev=current;current=current.next;index++}linkItem.next=current;prev.next=linkItem}this.length++;return true}else{return false}}},{key:"_remove",value:function _remove(node){if(this.length!==0){var current=this.head;var prev=null;while(current.value!==node&&current.next){prev=current;current=current.next}if(current.value===node){if(this.head===current){this.head=current.next}else{prev.next=current.next}this.length--}}return node}},{key:"_get",value:function _get(position){if(position>=0&&position<=this.length){var current=this.head;var index=0;while(index<position&&current){current=current.next;index++}return current&&current.value}else{return null}}}]);return LinkedList}();var Game=function(){function Game(){_classCallCheck(this,Game);this.$stage=document.querySelector("#stage");this.food=[];this.speed=150;this.pause=false;this.snake=new Snake(this.$stage);this.addFood();this.handleKeyDown=this.handleKeyDown.bind(this);this.handleBtnClick=this.handleBtnClick.bind(this);window.addEventListener("keydown",this.handleKeyDown);window.addEventListener("mousedown",this.handleBtnClick)}_createClass(Game,[{key:"handleBtnClick",value:function handleBtnClick(e){var target=e.target;var name=target.getAttribute("class");if(name){switch(true){case name.indexOf("up")>-1:this.snake.turn(38);break;case name.indexOf("right")>-1:this.snake.turn(39);break;case name.indexOf("down")>-1:this.snake.turn(40);break;case name.indexOf("left")>-1:this.snake.turn(37);break}}}},{key:"handleKeyDown",value:function handleKeyDown(e){var keyCode=e.keyCode;if(this.pause&&keyCode!==32){return}switch(true){case DIRECTIONS.indexOf(keyCode)>-1:this.snake.turn(keyCode);break;case keyCode===187:this.incSpeed();break;case keyCode===189:this.decSpeed();break;case keyCode===81:this.snake.MOVE=true;this.snake.FLASH=false;this.snake.BOOM=false;break;case keyCode===87:this.snake.FLASH=true;this.snake.MOVE=false;this.snake.BOOM=false;this.decSpeed();break;case keyCode===69:this.snake.BOOM=true;this.snake.FLASH=false;this.snake.MOVE=false;break;case keyCode===65:this.snake.COLOR=!this.snake.COLOR;break;case keyCode===32:this.pause=!this.pause}}},{key:"go",value:function go(){var _this2=this;var $grade=document.querySelector("#grade");$grade.innerHTML="\u5C0F\u86C7\u957F\u5EA6: <span class='number'>"+this.snake.body.length+"</span>  \u5403\u4E0B\u7684\u98DF\u7269: <span class='number'>"+this.snake.food+"</span>  \u6B65\u6570: <span class='number'>"+this.snake.step+"</span>  \u901F\u5EA6: <span class='number'>"+(550-this.speed)+"</span>";var $head=this.snake.body.head.value;var _getPosition=this.getPosition($head),bx=_getPosition.x,by=_getPosition.y;
var $food=this.food.find(function($item){var _getPosition2=_this2.getPosition($item),fx=_getPosition2.x,fy=_getPosition2.y;return fx===bx&&fy===by});if(!this.pause){this.snake.move(!!$food)}if(!!$food){var snakeLen=this.snake.body.length;if(snakeLen%5===0){this.incSpeed()}this.food.length=0;this.$stage.removeChild($food);this.addFood()}if(this.isAlive()){setTimeout(function(){_this2.go()},this.speed)}else{alert("小蛇已死, 埋了吧。");this.bury()}}},{key:"bury",value:function bury(){var $node=this.snake.body.removeLast();while($node){this.$stage.removeChild($node);$node=this.snake.body.removeLast()}this.food.length=0;this.$stage.innerHTML="";newGame()}},{key:"isAlive",value:function isAlive(){var $head=this.snake.body.head.value;var _getPosition3=this.getPosition($head),headX=_getPosition3.x,headY=_getPosition3.y;var stageSize=this.getSize(this.$stage);if(headX<0||headX>stageSize.width-this.snake.nodeSize.width||headY<0||headY>stageSize.height-this.snake.nodeSize.height){return false}var current=this.snake.body.head;while(current){var $node=current.value;var _getPosition4=this.getPosition($node),nodeX=_getPosition4.x,nodeY=_getPosition4.y;if($node!==$head&&nodeX===headX&&nodeY===headY){return false}current=current.next}return true}},{key:"incSpeed",value:function incSpeed(){this.speed=Math.max(10,this.speed-10)}},{key:"decSpeed",value:function decSpeed(){this.speed=Math.min(500,this.speed+10)}},{key:"addFood",value:function addFood(){var _computeFoodPosition=this.computeFoodPosition(),x=_computeFoodPosition.x,y=_computeFoodPosition.y;var $food=document.createElement("div");$food.className="food";$food.style.left=x+"px";$food.style.top=y+"px";$food.style.width=this.snake.nodeSize.width+"px";$food.style.height=this.snake.nodeSize.height+"px";this.$stage.appendChild($food);this.food.push($food);return $food}},{key:"computeFoodPosition",value:function computeFoodPosition(){var stageSize=this.getSize(this.$stage);var nodeSize=this.snake.nodeSize;var xSize=Math.floor(stageSize.width/nodeSize.width);var ySize=Math.floor(stageSize.height/nodeSize.height);var flag=false;var x=void 0;var y=void 0;do{flag=false;x=parseInt(Math.random()*(xSize-0),10)*nodeSize.width;y=parseInt(Math.random()*(ySize-0),10)*nodeSize.height;var current=this.snake.body.head;while(current){var pos=this.getPosition(current.value);if(pos.x===x&&pos.y===y){flag=true;break}current=current.next}}while(flag);return{x:x,y:y}}},{key:"getPosition",value:function getPosition($e){var x=parseFloat($e.style.left);var y=parseFloat($e.style.top);return{x:x,y:y}}},{key:"getSize",value:function getSize($e){var rect=$e.getClientRects()[0];var width=rect.width;var height=rect.height;return{width:width,height:height}}}]);return Game}();var Snake=function(){function Snake($stage){var _this3=this;_classCallCheck(this,Snake);this.FLASH=false;this.BOOM=false;this.MOVE=false;this.COLOR=false;this.$stage=$stage;this.direction=39;this.nodeSize={width:10,height:10};this.step=1;this.food=0;this.body=new LinkedList([10,9,8,7,6,5,4,3,2,1].map(function(num){return _this3.addNode(_this3.nodeSize.width*num,_this3.nodeSize.height)}))}_createClass(Snake,[{key:"addNode",value:function addNode(x,y){var $node=document.createElement("div");$node.className="node";$node.style.left=x+"px";$node.style.top=y+"px";$node.style.width=this.nodeSize.width+"px";$node.style.height=this.nodeSize.height+"px";this.$stage.appendChild($node);return $node}},{key:"move",value:function move(){var eat=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var $head=this.body.head.value;var _getPosition5=this.getPosition($head),x=_getPosition5.x,y=_getPosition5.y;var nextX=x;var nextY=y;switch(this.direction){case 37:nextX=x-this.nodeSize.width;break;case 38:nextY=y-this.nodeSize.height;break;case 39:nextX=x+this.nodeSize.width;break;case 40:nextY=y+this.nodeSize.height;break}this.body.addFirst(this.addNode(nextX,nextY));if(!eat){this.$stage.removeChild(this.body.removeLast())}else{this.food++}this.updateColorClass();this.step++}},{key:"updateColorClass",value:function updateColorClass(){var snake=this.body;var len=snake.length;var current=snake.head;var prevNum=void 0;var index=0;var nowNum=Math.floor(Math.random()*len);while(current){var $node=current.value;this._removeClass($node,/^d-\d+$/);this._addClass($node,"d-"+index);var num=void 0;if(!this.COLOR){this._removeClass($node,/^n-\d+$/)}else{if(this.FLASH){this._removeClass($node,/^n-\d+$/);num=Math.floor(Math.random()*len);this._addClass($node,"n-"+num)}else{if(this.MOVE){if(index===0){this._removeClass($node,/^n-\d+$/);this._addClass($node,"n-"+nowNum)}else{this._addClass($node,"n-"+prevNum)}var flag=/\bn-(\n+)\b/.exec($node.getAttribute("class"));prevNum=flag?parseInt(flag[1],10):0}else{if(this.BOOM){this._removeClass($node,/^n-\d+$/);this._addClass($node,"n-"+nowNum)}else{this._removeClass($node,/^n-\d+$/);this._addClass($node,"n-"+index)}}}}current=current.next;index++}}},{key:"turn",value:function turn(type){var direction=this.direction;if(~DIRECTIONS.indexOf(type)){if(type===37&&direction===39||type===38&&direction===40||type===39&&direction===37||type===40&&direction===38){return
}this.direction=type}}},{key:"getPosition",value:function getPosition($node){var x=parseFloat($node.style.left);var y=parseFloat($node.style.top);return{x:x,y:y}}},{key:"_addClass",value:function _addClass($e,className){var classString=$e.getAttribute("class");$e.setAttribute("class",classString?classString+" "+className:className)}},{key:"_removeClass",value:function _removeClass($e,nameReg){var classArr=$e.getAttribute("class").split(" ");classArr=classArr.filter(function(item){return !nameReg.test(item)});$e.setAttribute("class",classArr.join(" "))}}]);return Snake}();function newGame(){var game=new Game();game.go()}newGame();